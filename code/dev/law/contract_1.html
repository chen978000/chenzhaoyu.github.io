<!DOCTYPE html>
<html class="no-js">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<meta name="keywords" content="" /> 
<meta name="description" content="">
<link rel="stylesheet" type="text/css" href="font/iconfont.css">
<link type="text/css" rel="stylesheet" href="css/public.css" />
<link type="text/css" rel="stylesheet" href="css/index.css" />
	<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
	<script src="js/vue.js" type="text/javascript"></script>
	<script src="js/util.js" type="text/javascript"></script>
	<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/my.js" type="text/javascript"></script>
	<style>
		.checkbox_box{
			text-align: left;
			height: 30px;
			line-height: 30px;
		}
		.btn_box{
			width: 180px;
			margin: 10px auto;
			color: #fff;
			background: #ff6b00;
			text-align: center;
			height: 32px;
			border-radius: 32px;
			line-height: 32px;
		}
    .unActive{
      width: 180px;
      margin: 10px auto;
      color: #222;
      background: #fff;
      border: 1px solid #2b2b2b;
      text-align: center;
      height: 32px;
      border-radius: 32px;
      line-height: 32px;
    }
	</style>
<title>选择合同</title>
<body>
<div id="app">
	<header>
		<div class="head_box">
			<a href="javascript:void(0);" onclick="goBack()" class="head_left"><i class="iconfont">&#xe6d9;</i></a>
			<span>选择合同</span>
			<a href="" class="head_right"></a>
		</div>
	</header>
	<section v-if="(cnode_type=='question-singlechoice') || (cnode_type=='question-multichoices' && isSingle)">
		<div class="problem">
			<p>{{quetion}}</p>
			<div class="problem_only">
				<div :class="(item.default || item.selected)?'problem_item_box_active':'problem_item_box'" v-for="item in choices" @click="getQA(item.index)" >{{item.prompt}}</div>
			</div>
		</div>
	</section>
	<section v-if="cnode_type=='question-fillin'">
		<div class="problem">
			<p>{{quetion}}</p>
			<div class="problem_only">
				<div class="input_box" v-for="(item,index) in inputList">
					{{item.prompt}}:
					<div class="fill_input_box">
						<input class="fill_input" :id="'text'+index" type="text" v-model="item.value" >
					</div>
				</div>
				<div class="fill_btn" @click="done">完成</div>
			</div>
		</div>
	</section>
	<section v-if="cnode_type=='question-multichoices'&&!isSingle">
		<div class="problem">
			<p>{{quetion}}</p>
			<div v-for="(item,index) in choices" :class="item.selected?'btn_box':'unActive'" @click="checkIt(index)">{{item.prompt}}</div>
      <div class="fill_btn" @click="duoxuan">完成</div>
    </div>
	</section>
  <div class="loading_box" v-if="loading">
    <div class="loader loader--style1" title="0">
      <svg version="1.1" id="loader-1" x="0px" y="0px"
   width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
  <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
    s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
    c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
  <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
    C22.32,8.481,24.301,9.057,26.013,10.047z">
    <animateTransform attributeType="xml"
      attributeName="transform"
      type="rotate"
      from="0 20 20"
      to="360 20 20"
      dur="0.5s"
      repeatCount="indefinite"/>
    </path>
  </svg>
    </div>
  </div>
	<div class="problem_popup" v-if="isSend">
		<div class="problem_within">
			合同已发送
		</div>
	</div>
  <footer>
    <ul class="footer_ul">
      <li class='footer_ul_li am_active'>
        <a href='my.html'>
          <i class='iconfont'>&#xe79e;</i>
          <p>首页</p>
        </a>
      </li>
      <li class='footer_ul_li'>
        <a href='my_data.html'>
          <i class='iconfont'>&#xe7a1;</i>
          <p>我的</p>
        </a>
      </li>
    </ul>
  </footer>
</div>

<!--<script src="js/footer.js"></script>-->
<script>

	var app = new Vue({
    el: '#app',
    data: {
			quetion: '',
			choices: [],
			inputList:[],
			cnode_type: '',
			isFill: true,
			isSend: false,
			loading: false,
      multiList: [],
			isSingle: false
    },
		mounted(){
      this.getQA(getUrlKey('index'))
		},
		methods: {
      //获取问题
      getQA(id){
        const that = this
        const session_id = sessionStorage.getItem('session_id')
        const question_id = sessionStorage.getItem('question_id')
        const index = id
        that.loading = true
				let arguments = {}
				if(that.isSingle){
          arguments = {
            question_id: question_id,
            choice_indexes: [id]
					}
				}else{
          arguments = {
            question_id: question_id,
            choice_index: index,
          }
				}
				network({
					params: {
						"arguments": arguments
					},
					path: `compute/${session_id}`,
					method: 'post',
					head: [
						"Content-Type: application/json",
						`x-dc-uid: 61ca33bc-8365-46b8-9cff-c08f756a8082`
					],
          success: function (e) {
            that.loading = false
            const data = JSON.parse(e);
						console.log(data)
            if(data.cnode_type=='exit'){
              window.location='./my.html'
              return
            }
            that.quetion = data.cnode_body.text;
            that.choices = data.cnode_body.choices;
						that.cnode_type = data.cnode_type;
						if(data.cnode_type && data.cnode_body.single_choice){
              that.isSingle = true
						}else{
              that.isSingle = false
            }
						if(data.cnode_body.choices){
              that.multiList = that.choices.map(item=>{
                if(item.selected){
                  return item.index
                }
              }).filter(item=>item)
						}

						if(data.cnode_body.questions){
              that.inputList= data.cnode_body.questions.map(item=>{
                let a = item
								a.value = ''
                return a
              })
							console.log(that.inputList)
						}
					}
				})
			},
			// 验证是否填写完成
      done(){
        const that = this;
        let arr = [];
        this.inputList.map((item,index)=>{
          let ele = document.getElementById("text"+index);
          let a = item
					a.value = ele.value
          arr.push(a)
        })
				console.log(arr)
        const answers = arr.map(item=>{
          if(!item.value){
            alert(`请完善${item.prompt}`)
            that.isFill = false
					}else{
            that.isFill = true
            return {
              fillin_id: item.fillin_id,
              answer: item.value
						}
					}
				})
        if(that.isFill){
          that.fillin(answers)
        }

        // sessionStorage.setItem('answers',JSON.stringify(answers))
                // window.location = './add_ziliao.html'

			},
      // 填空
      fillin(answers){
        const that = this;
        const session_id = sessionStorage.getItem('session_id')
        const question_id = sessionStorage.getItem('question_id')
          // const answers = JSON.parse(sessionStorage.getItem('answers'))
        that.loading = true
        network({
          params: {
              "arguments": {
                  question_id: question_id,
                  answers: answers
              }
          },
          path: `compute/${session_id}`,
          method: 'post',
          head: [
              "Content-Type: application/json",
              `x-dc-uid: 61ca33bc-8365-46b8-9cff-c08f756a8082`
          ],
          success: function (e) {
            that.loading = false
            const data = JSON.parse(e);
            console.log(data)
            that.quetion = data.cnode_body.text;
            that.choices = data.cnode_body.choices;
            that.cnode_type = data.cnode_type;
            if(data.cnode_type && data.cnode_body.single_choice){
              that.isSingle = true
            }else{
              that.isSingle = false
            }
            if(data.cnode_body.choices){
              that.multiList = that.choices.map(item=>{
                if(item.selected){
                  return item.index
                }
              }).filter(item=>item)
            }
            if(data.cnode_body.questions){
              that.inputList= data.cnode_body.questions.map(item=>{
                let a = item
								a.value = ''
                return a
              })
              console.log(that.inputList)
            }
            if(data.cnode_type=='invite'){
              that.isSend = true
            }
          }
        })
      },
			// 多选
      duoxuan(){
        const that = this
        const session_id = sessionStorage.getItem('session_id')
        const question_id = sessionStorage.getItem('question_id')
        that.loading = true
        network({
              params: {
                  "arguments": {
                      question_id: question_id,
                      choice_indexes: this.multiList
                  }
              },
              path: `compute/${session_id}`,
              method: 'post',
              head: [
                  "Content-Type: application/json",
                  `x-dc-uid: 61ca33bc-8365-46b8-9cff-c08f756a8082`
              ],
              success: function (e) {
                that.loading = false
                const data = JSON.parse(e);
                  console.log(data)
                  if(data.cnode_type=='exit'){
                      window.location='./my.html'
                      return
                  }
                  that.quetion = data.cnode_body.text;
                  that.choices = data.cnode_body.choices;
                  that.cnode_type = data.cnode_type;
									if(data.cnode_type && data.cnode_body.single_choice){
										that.isSingle = true
									}else{
										that.isSingle = false
									}
									if(data.cnode_body.choices){
										that.multiList = that.choices.map(item=>{
											if(item.selected){
												return item.index
											}
										}).filter(item=>item)
									}
                  if(data.cnode_body.questions){
										that.inputList= data.cnode_body.questions.map(item=>{
										  let a = item
											a.value = ''
												return a
										})

                      console.log(that.inputList)
                  }


              }
          })
      },
      // 选中
      checkIt(index){
        this.choices = this.choices.map(item=>{
          if(item.selected){
            return item
          }else{
            let a = item
						a.selected = false
            return a
          }
        })
        this.choices[index].selected = !this.choices[index].selected
				this.multiList = this.choices.map(item=>{
				  if(item.selected){
				    return item.index
					}
				}).filter(item=>item)
				console.log(this.multiList)
      },
			// 生成合同
      contract(){
        const that = this
        const session_id = sessionStorage.getItem('session_id')
        const question_id = sessionStorage.getItem('question_id')
        that.loading = true
        network({
          params: {
          },
          path: `session/${session_id}/download`,
          method: 'post',
          head: [
              "Content-Type: application/json",
              `x-dc-uid: 61ca33bc-8365-46b8-9cff-c08f756a8082`,
              `session_id: ${session_id}`
          ],
          success: function (e) {
            that.loading = false
            const data = JSON.parse(e);
            console.log(data)
          }
        })
        },


		}
	})
</script>
</body>
</html>